---
title: "Use Case: Florentine Families"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{07 use case}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette describes a typical use case of the `netrankr` packages. It contrasts
the usual centrality analysis based on indices with the dominance based assessment.
It is advisable to read the other vignettes before going through this example.
________________________________________________________________________________


## Setup
[Padget & Ansell, 1993](http://www.journals.uchicago.edu/doi/abs/10.1086/230190)

```{r setup, warning=FALSE,message=FALSE}
library(igraph)
library(netrankr)
library(magrittr)
library(ggplot2)
data("florentine_m")
#Delete Pucci family (isolated)
florentine_m <- delete_vertices(florentine_m,which(degree(florentine_m)==0))
```

```{r plot,fig.height=5,fig.width=5,fig.align='center'}
#plot the graph
set.seed(111)
plot(florentine_m,
     vertex.label.cex=V(florentine_m)$wealth*0.01,
     vertex.label.color="black",
     vertex.color="white",
     vertex.frame.color="gray")
```

________________________________________________________________________________

## Most central family (Index approach)

The network is often used to benchmark new centrality indices. The premise is that
the Medici should always emerge as one of the most central once (if not **the** most central).  

We start by applying some of the standard centrality indices given in the `igraph` package.

```{r cent}
cent.df <- data.frame(
  degree=degree(florentine_m),
  betweenness=betweenness(florentine_m),
  closeness=closeness(florentine_m),
  eigenvector=eigen_centrality(florentine_m)$vector,
  subgraph=subgraph_centrality(florentine_m))

# most central family according to the 5 indices
V(florentine_m)$name[apply(cent.df,2,which.max)]
```

In all cases, the Medici are considered to be the most central family. However,
it is possible to find indices that rank other families on top. An example is
*odd subgraph centrality*, which can be assembled with the `netrankr` package.

```{r cent_new}
#odd subgraph centrality
sc_odd <- florentine_m %>% 
  indirect_relations(type = "walks",FUN = walks_exp_odd) %>% 
  aggregate_positions(type = "self")
rank(sc_odd)
#family with highest score 
V(florentine_m)$name[which.max(sc_odd)]
```

In this example, the Strozzi family are considered to be the most central family
and the Medici are ranked third.

Although we have found $5$ indices that consider the Medici the most central family,
we can not guarantee, that there do not exist hundreds (or thousands?) of indices
that would give an entirely different result. 

________________________________________________________________________________

## Most central family (Probabilistic approach)

We start by calculating the neighborhood-inclusion preorder, that is, the most rudimentary
requirenment for any centrality index.

```{r ni}
P <- neighborhood_inclusion(florentine_m)
```

With the function `comparable_pairs()` we can assess how many pairs of families are already
ordered, before applying any index.
```{r ni_comp}
comparable_pairs(P)
```

Only around `r round(comparable_pairs(P)*100,0)`% of pairs of families are comparable,
leaving `r 100-round(comparable_pairs(P)*100,0)`% of pairs of families that could be 
ordered (basically) arbitrarily.

If we want to visually assess the dominance relations we can use the function `dominance_graph()`.

```{r dom_graph,fig.height=5,fig.width=5,fig.align='center'}
d <- dominance_graph(P)
V(d)$name <- V(florentine_m)$name
set.seed(113)
plot(d,vertex.label.color="black",
     vertex.color="white",
     vertex.frame.color="gray",
     edge.arrow.size=0.5)
```

The Castellan family neither dominates nor is dominated by any other family. This means, that we
can find indices that potentially rank them on top or on the bottom, or anything in between.

To better assess the potential ranks of nodes, we can plot the rank intervals with
`plot_rank_intervals()`

```{r rk_inter,fig.align='center',fig.width=5,fig.height=5}
plot_rank_intervals(P,names=V(florentine_m)$name)
```

Observe how big the intervals are, indicating that there is ample scope to rank the
families differently. These intervals, however, only give us a rough estimate of this
arbitrariness and does not give us any rank probabilities. To get all exact probabilities,
we use the function `exact_rank_prob()`.

```{r probs}
res <- exact_rank_prob(P,names=V(florentine_m)$name)

```
There are `r format(res$lin.ext,scientific = F,big.mark = ",")` different possibilities to rank
the families! (*the value is stored in `res$lin.ext`. *). This means that theoretically, we
can find almost 4 Billion indices that rank the families differently. 

The *rank probabilities* of families can be found in `res$rank.prob`. They are returned 
as a matrix where rows are families and columns are ranks. That is, an entry in 
row $u$ and column $k$ gives the probability that $u$ has rank $k$ (larger $k$ indicate higher ranks)
Mostly, you will be interested in the probability to be the most central node of a network.
Below, we calculate these probability for all families and return the one's that have
a higher probability than $0.1*$.

```{r likely_most_central}
top_rank_prob <- res$rank.prob[,15]
names(top_rank_prob) <- V(florentine_m)$name
round(top_rank_prob[top_rank_prob>0.1],3)
```

The Strozzi family, with $0.13$, has the highest probability to be top ranked, followed
by the Medici with $0.12$. 

If we are only interested in a subset of nodes, in our case maybe the Strozzi and Medici,
we can assess the *relative rank probabilities* in `res$relative.rank`. Again, 
probabilities are returned as matrix objects, where an entry in row $u$ and column $v$
gives the probability that $u$ is ranked below $v$. Below we calculate this probability
for the Strozzi and Medici.

```{r medici_strozzi,eval=TRUE}
id_strozzi <- which(V(florentine_m)$name=="Strozzi") 
id_medici  <- which(V(florentine_m)$name=="Medici")
res$relative.rank[id_strozzi,id_medici]
```

The probability that the Strozzi are less central than the Medici is 
`r round(res$relative.rank[id_strozzi,id_medici],2)` and thus very close to a "fifty-fifty" chance.

The last result of interest returned by `exact_rank_prob()` are the *expected ranks* in
`res$expected.rank`. The expected ranks, as the name indicates, returns the ranks that we
expect families to have in a valid centrality ranking.

```{r exp_rank}
res$expected.rank
```

________________________________________________________________________________

## Hypothesis

Can proximity explain wealth?

Index approach
```{r dist_vs_wealth}

#Closeness
c_C <- florentine_m %>% 
  indirect_relations(type="geodesic") %>% 
  aggregate_positions(type="invsum")

#harmonic closeness
c_HC <- florentine_m %>% 
  indirect_relations(type="geodesic",FUN=dist_inv) %>% 
  aggregate_positions(type="sum")

cor(c_C,V(florentine_m)$wealth,method="kendall")
cor(c_HC,V(florentine_m)$wealth,method="kendall")
```

There doesn't seem to be much evidence, yet there are several additional distance based
indices!

```{r dist_vs_wealth2}
#residual closeness (Dangalchev,2006)
c_RC <- florentine_m %>% 
  indirect_relations(type="geodesic",FUN=dist_2pow) %>% 
  aggregate_positions(type="sum")

#integration centrality (Valente & Foreman, 1998)
dist_integration <- function(x){
  x <- 1 - (x - 1)/max(x)
}
c_IN <- florentine_m %>% 
  indirect_relations(type="geodesic",FUN=dist_integration) %>% 
  aggregate_positions(type="sum")

cor(c_RC,V(florentine_m)$wealth,method="kendall")
cor(c_IN,V(florentine_m)$wealth,method="kendall")
```

There are also some indices with parameters to maximize correlation.

```{r distalpha_wealth,warning=FALSE}
#generalized closeness (Agneessens et al.,2017) (alpha>0)
alpha <- c(seq(0.01,0.99,0.01),seq(1,10,0.1))
scores <- 
sapply(alpha,function(x)
    florentine_m %>% 
      indirect_relations(type="geodesic",FUN=dist_dpow,alpha=x) %>% 
      aggregate_positions(type="sum")
)
cors <- apply(scores,2,
              function(x)cor(x,V(florentine_m)$wealth,method="kendall"))

res_gc <- c(max(cors),alpha[which.max(cors)])

#decay centrality (Jackson, 2010) (alpha in [0,1])
alpha <- seq(0.01,0.99,0.01)
scores <- 
sapply(alpha,function(x)
  florentine_m %>% 
    indirect_relations(type="geodesic",FUN=dist_powd,alpha=x) %>% 
    aggregate_positions(type="sum")
)
cors <- apply(scores,2,
              function(x)cor(x,V(florentine_m)$wealth,method="kendall"))

res_dc <- c(max(cors),alpha[which.max(cors)])
```

The highest correlation for generalized closeness is `r res_gc[1]` achieved for 
$\alpha$= `r res_gc[2]`  

The highest correlation for decay centrality is `r res_dc[1]` achieved for 
$\alpha$=`r res_dc[2]`